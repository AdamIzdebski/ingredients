---
title: "Vignette for aspect importance"
author: "Katarzyna PÄ™kala"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{Survival on the RMS Titanic}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)
```

# Data and logistic regression model for Titanic survival

Vignette will present the aspect_importance() function on the dataset *titanic*. Dataset is available in the `DALEX` package.  
At the beginning, we download *titanic* dataset and build logistic regression model.

```{r}
library("DALEX")
head(titanic)
titanic <- na.omit(titanic)
model_titanic_glm <- glm(survived == "yes" ~ class+gender+age+sibsp+parch+fare+embarked,
               titanic, family = "binomial")

```

#  Preparing additional parameters

Before using aspect_importance() we need to:

* group features of the dataset into aspects, 
* define the size of the sample that will allow us to calculate aspect importance,
* choose observation for which we explain aspects' importance.


```{r}
aspects <- list(wealth = c("class", "fare"), family = c("gender", "sibsp", "parch"), age = "age", embarked = "embarked")

B <- 100
passenger <- data.frame(
  class = factor("1st", levels = c("1st", "2nd", "3rd", "deck crew", "engineering crew", "restaurant staff", "victualling crew")),
  gender = factor("male", levels = c("female", "male")),
  age = 8,
  sibsp = 0,
  parch = 0,
  fare = 72,
  embarked = factor("Southampton", levels = c("Belfast", "Cherbourg", "Queenstown", "Southampton"))
)
passenger
predict(model_titanic_glm, passenger)

```

# Calculating aspect importance (logistic regression)

We call aspect_importance() function and see that features that are included in **wealth** (that is *class* and *fare*) have the biggest postive contribution on survival prediction for the passenger. **Age** feature has also quite strong positive influence. **Family** features ("gender", "sibsp", "parch") have some negative influence, of less importance than **wealth** and **age**. Port of embarkment (only one feature in this group) has only slightly negative influence.


```{r}
library("ggplot2")
library("ingredients")

titanic_glm_ai <- aspect_importance(model_titanic_glm, titanic, predict, passenger, aspects, 100)

titanic_glm_ai
plot(titanic_glm_ai) + ggtitle("Aspect importance for the selected passenger (logistic reg.)")
```


# Calculating aspect importance with explainer

Aspect_importance() could be also called using DALEX explainer as showed below.

```{r}
explain_titanic_glm <- explain(model_titanic_glm, 
                      data = titanic[,-9],
                      y = titanic$survived == "yes", 
                      predict_function = predict,
                      label = "Logistic Regression")

titanic_glm_ai <- aspect_importance(explain_titanic_glm, passenger, aspects, 100)
titanic_glm_ai

```

# Random forest model for Titanic survival

Secondly, we prepare random forest model for the *titanic* dataset.

```{r}
library("randomForest")
model_titanic_rf <- randomForest(survived == "yes" ~ gender + age + class + embarked +
                                   fare + sibsp + parch,  data = titanic)

```

# Calculating aspect importance (random forest)

After calling aspect_importance() on the random forest model, we can observe that this time every aspect has smaller contribution to the prediction. Especially **wealth**, the biggest postive contributor in logistic regression case, this time has very slight influence.

```{r}
titanic_rf_ai <- aspect_importance(model_titanic_rf, titanic, predict, passenger, aspects, 100)

titanic_rf_ai
plot(titanic_rf_ai) + ggtitle("Aspect importance for the selected passenger (random for.)")
```

# Session info

```{r}
sessionInfo()
```
